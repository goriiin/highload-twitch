# Twitch

## 1. Тема и целевая аудитория

Twitch -  видеостриминговый сервис.

### MVP

1. Регистрация/авторизация
2. Создать стрим
3. Смотреть стрим
4. Подписка на стримера
5. Писать в чат
6. Ставить реакции стриму, лайк/дизлайк 
7. Поиск стримеров по категориям, тегам, ключевым словам
8. Хранение записи стрима
9. Просмотр записи

### Ключевые продуктовые решения

- рекомендации стримов на основе интересов
- бесконечная лента прямых трансляций
- 7 дней хранения записи прямых трансляций для обычных пользователей и 60 дней для партнеров, на количество самих записей в этот период ограничений нет [^5] 
- буферизация прямых трансляций и записей 

### Целевая аудитория

#### Метрики вовлеченности:

- MAU 240M[^1]
- DAU 30M[^1]
- общее количество посещений за январь 2025 - 1.2B [^3]
- В месяц 7M человек запускает стрим хотя бы раз, активных стримеров в день 1.2M [^3]
- одновременно просматривает в среднем 2.5M пользователей, пик 7M [^3]
- одновременное количество прямых трансляций 100K  [^3]
- среднее количество стримов в месяц более 7M  [^3]
- было отправлено более 28B ообщений в чате за год,
   т.е ~80M в день, ~2.33B в месяц (2023 год) [^4]
- на мобильные устройства приходится 35% всех просмотров [^1]
- средняя продолжительность прямой трансляции на Twitch 3 часа[^2]
- смотрят в среднем 1,7B часов контента в месяц  [^3]
- среднее время сессии 36 минут [^7]

#### Рекорды:

- одновременное количество зрителей - 3.44M
- максимальное количество подписчкиков - 19M

#### Распределение аудитории по полу и возрасту:

- 52% пользователей в возрасте 25-34 лет [^2]
- 22% пользователей в возрасте 35-44 лет [^2]
- 72% пользователей - мужчины

#### Распределение аудитории по странам

Десктоп трафик в 2024 [^2] 

| №   | Страна   | Количество пользователей | % от общего числа |
| --- | -------- | ------------------------ | ----------------- |
| 1   | США      | 49.5M                    | 20.6%             |
| 2   | Германия | 16.9M                    | 7.17%             |
| 3   | Россия   | 11.6M                    | 4.85%             |
| 4   | Франция  | 11.44M                   | 4.61%             |
| 5   | Япония   | 10.5M                    | 4.39%             |

## 2. Расчет нагрузки

### Продуктовые метрики
#### Аудитория [^1]

| Тип | Количество |
| --- | ---------- |
| MAU | 240M       |
| DAU | 30M        |

#### Действия пользователя

| Тип                     | Среднее в месяц<br>от 1 юзера | В месяц <br>от всех юзеров   |
| ----------------------- | ----------------------------- | ---------------------------- |
| Регистрация/авторизация | 0.05                          | 2M (регистраций) + 12M = 14M |
| Проведение<br>стрима    | 3ч                            | 75M часов                    |
| Просмотр<br>стрима      | 14мин*                        | 1.7B часов [^3]              |
| Подписки                | 3                             | 720M                         |
| Сообщения<br>в чате     | 9.7                           | 2.33B  [^4]                  |
| Реакций на<br>стрим     | 1.5                           | 360M                         |
| Поиск                   | 20                            | 4.8B                         |
| Посещения <br>профиля   | 4                             | 960M                         |
| Хранение записи         | 3                             | 720M                         |
| Просмотр записи         | 5                             | 1.2B                         |

- ( \* ) Из расчета, что MAU 240M[^1]

#### Хранилища

##### Пользователя:

| Тип               | Размер |
| ----------------- | ------ |
| Аватарка          | 200КБ  |
| Фото баннер       | 200КБ  |
| Общая информация* | ~2КБ   |
| Итого             | 402КБ  |

- ( \* ) Имя пользователя и отображаемое имя пользователя до 25 символов, информация  о себе до 300 символов, кодировка utf8 - 4б, итого 350 * 4б / 1024 ~ 2КБ
- Максимальный размер загружаемых аватарки/банеров 10МБ, но сжимается до 200КБ

##### Стримера

| Тип                 | Размер   |
| ------------------- | -------- |
| Стримы*             | 716,13ГБ |
| Загружаемые видео** | 397,85ГБ |
| Чат***              | 126Мб    |
| Итого               | 1113.98Гб |


У Twitch нет возможности вести прямую трансляцию в 2к и 4к, это находится на этапе тестирования [^6]. Twitch рекомендует делать трансляцию в 1080р с битрейтом 6000кбит/с [^6] . Средний размер файла на 1минуту с таким разрешением 40МБ. Но так как при просмотре записи Twitch предлагает выбор из качеств видео: 720р60 - в среднем 30МБ/мин, 480 - 11МБ/мин, 360 - 7МБ/мин, 240 - 5МБ/мин, 144 - 3МБ/мин.

Без потери качества можно сжать на 30%

- ( \* ) Итого, если человек ведет прямые трансляции каждый день с средней продолжительностью 3ч, если он партнер Twitch, то запись храниться 60дней. 60 * 3ч * 60мин * (40 + 30 + 11 + 7 + 5 + 4) = 1047600МБ. Итого после сжатия 1047600МБ* 0.7 = 716,13Гб
- ( \** ) Максимум можно сохранить 100ч [^8]  . 100 * 60 * (40 + 30 + 11 + 7 + 5 + 4)МБ = 568,36ГБ. Итого: 568,36ГБ * 0.7 = 397,85
- ( \*** ) Из расчетов действий пользователя получим, что среднее количество сообщений в чате 1100, максимальный размер сообщения 500 символов [^9]  , при кодировке utf8 1100 * 500 * 4Б * 60= 126МБ

### Технические метрики
#### Хранилища

Точных данных по количеству зарезарегистрированных аккаунтов на Twitch нет, при MAU 240M пусть общее количество будет 2.4B (1 к 10).

Из расчета, что 7M активных стримеров в месяц (т.е проводят хотя бы 1 трансляцию в месяц), запись стрима хранится 2 месяца, допустим за 2 месяца будет 10M стримов.

| Тип          | Размер  |
| ------------ | ------- |
| Пользователи | 49.1ТБ  |
| Стримеры     | 1062,37ПБ |
| Итого        | 1 062,42ПБ |

#### Трафик и запросы
Twitch работает по протоколу RTMP [^10] ,  который работает поверх TCP. Раз в секунду делается запрос на получение фрагмента стрима.

| Тип                         | Средний RPS | Сетевой трафик<br>(средний) | Пиковый RPS | Сетевой трафик<br>(пиковый) |
| --------------------------- | ----------- | --------------------------- | ----------- | --------------------------- |
| регистрация<br>/авторизация | 6           | 1200Кбит/с                  | 12          | 2400Кбит/с                  |
| Проведение<br>стрима        | 100К        | 0.6Тбит/с                   | 250K        | 1.2Тбит/с                   |
| Просмотр<br>стрима          | 2.5M        | 15Тбит/с                    | 5M          | 30Тбит/с                    |
| Подписки                    | 300         | 240Мбит/с                   | 600         | 480Мбит/с                   |
| Чат                         | 1000        | 20Мбит/с                    | 2000        | 40Мбит/с                    |
| Реакции                     | 250K        | 120Мбит/с                   | 500K        | 240Мбит/с                   |
| Поиск                       | 2K          | 1000Мбит/с                  | 4К          | 2000Мбит/c                  |
| Переход <br>в профиль       | 370         | 1200Мбит/с                  | 740         | 2400Мбит/с                  |
| Хранение записи             | 300         | 1.72Гбит/с                  | 600         | 3.44Гбит/с                  |
| Просмотр записи             | 400         | 2.9Гбит/с                   | 800         | 5.8Гбит/с                   |
| Итого                       | 2.9M        | 15.6Тбит/с                  | 5.8M        | 32.7Тбит/с                  |

## 3. Глобальная балансировка нагрузки

### Функциональное разбиение по доменам (при наличии, нужно для следующего пункта)

Исходя из среднего RPS и потребления трафика можно выделить несколько доменов:
- streamer.twitch.tv
- viewer.twitch.tv
- chat.twitch.tv
- vod.twitch.tv (Video on Demand)

Основной тип нагрузки приходиться на сервис стриминга, логично вывести его в отдельный домен. Также много трафика уходит на просмотр. Большой  
### Обоснования расположения ДЦ (влияние на продуктовые метрики)

Twitch не предоставляет гарантии единой задержки для всех пользователей и может меняться в зависимости от скорости интернета, к примеру на картинке снизу, настройка слева - "4g - быстрый", справа - "4g - медленный", и задержка может замедлиться динамически при замедлении интернета и исчерпании буфера.

![MyCollages](https://github.com/user-attachments/assets/e17e32ac-505a-4455-89df-c4aa0acb9720)

При отсутствии гарантии по длительности задержки ЦОД Twitch можно расположить исходя из плотности населения и популярности сервиса в регионе.

В [части 1](#распределение-аудитории-по-странам), привел информацию по десктоп трафику, но нужно расширить и на мобильный трафик. 

Так как точные данные по трафику не раскрыты, можно сделать некоторые выводы из локальности языков [^11]:

| Язык          | Среднее количество<br>одновременных зрителей | Среднее количество<br>одновременных стримов |
| ------------- | -------------------------------------------- | ------------------------------------------- |
| Английский    | 1134.2K                                      | 56.1K                                       |
| Русский       | 253.7K                                       | 7.1K                                        |
| Испанский     | 185.5K                                       | 8.1K                                        |
| Немецкий      | 161K                                         | 4.6K                                        |
| Французкий    | 159.6K                                       | 4.9K                                        |
| Португальский | 156.1K                                       | 4.5K                                        |
| Японский      | 142.2K                                       | 4.5K                                        |

- На **испанском** языке говорят в следующих странах: Испания, страны Латинской Америки
- На **немецком** языке говорят в следующих странах: Германия, Австрия, Лихтенштейн, а также одним из официальных языков Швейцарии, Люксембурга и Бельгии.
- На русском языке говорят в следующих странах: Россия и Беларусь
- На французком языке говорят: 
	- в странах Европы: Франция, Бельгия, Люксембург и др
	- в странах Америки: Канада, США
	- в странах Африки
- На португальском говорят в следующих странах: Бразилия, в странах Африки

Исходя из этой информации можно преобразовать таблицу

| №   | Страна / Регионы                                                              | Основной язык | Десктоп (пользователей, млн / доля) | (сред. зрители / стримы) |
| --- | ----------------------------------------------------------------------------- | ------------- | ----------------------------------- | ------------------------ |
| 1   | США                                                                           | Английский    | 49.5M / 20.6%                       | 1134.2K / 56.1K          |
| 2   | Германия и сопутств. страны (Австрия, Швейцария, Лихтенштейн)                 | Немецкий      | 16.9M / 7.17%                       | 161K / 4.6K              |
| 3   | Россия, Беларусь, Казахстан                                                   | Русский       | 11.6M / 4.85%                       | 253.7K / 7.1K            |
| 4   | Франция и франкофонные регионы (Бельгия, Люксембург, Канада, часть США и др.) | Французский   | 11.44M / 4.61%                      | 159.6K / 4.9K            |
| 5   | Япония                                                                        | Японский      | 10.5M / 4.39%                       | 142.2K / 4.5K            |
| 6   | Испания и Латинская Америка                                                   | Испанский     | –                                   | 185.5K / 8.1K            |
| 7   | Бразилия и африканские страны                                                 | Португальский | –                                   | 156.1K / 4.5K            |


![Pasted image 20250227234712](https://github.com/user-attachments/assets/4d2d929e-1fdc-493d-80b7-eae9393d4c8a)

![Pasted image 20250228004354](https://github.com/user-attachments/assets/a0542fb2-f670-4100-972f-c36190cdc328)

Расположение ЦОД:
- В США: Сан-Франциско(Северная Калифорния), Лос-Анджелес(Калифорния), Нью-Йорк, Чарльстон(Южная Каролина), Колумбус(Огайо)
- В Великобритании: Лондон
- В Мексике: Мехико
- В Бразилии: Сан-Паулу
- В Испании: Мадрид
- Во Франции: Париж 2шт
- В Италии: Милан
- В Германии: Франкфурт 2шт
- В Японии: Токио, Осако
- В России: Москва, Санкт-Петербург, Новосибирск 
- В Австралии: Сидней
- В Африке, страна Камерун: Яунде
- В Канаде: Торонто
### Расчет распределение запросов из секции "Расчет нагрузки" по типам запросов по датацентрам

| Язык          | avg RPS просмотр прямой трансляции (в тысячах) | Доля* (%) | Принадлежность к датацентрам                                                           |
| ------------- | ---------------------------------------------- | --------- | -------------------------------------------------------------------------------------- |
| Английский    | 1134.2                                         | ≈52.9%    | США(Сан-Франциско,Лос-Анджелес, Австралия,Нью-Йорк, Чарльстон) Англия(Лондон)          |
| Русский       | 253.7                                          | ≈11.8%    | Россия(Москва ~6%, Санкт-Петербург ~4%, Новосибирск ~1.8%)                             |
| Испанский     | 185.5                                          | ≈8.7%     | Делится на: Испания (Мадрид – ≈4.3%) и Мексика (Мехико – ≈4.3%)                        |
| Немецкий      | 161                                            | ≈7.5%     | Германия(Франквурт)                                                                    |
| Французский   | 159.6                                          | ≈7.4%     | Делится на: Франция (Париж – ≈3.7%), Канада (Торонто – ≈1.9%) и Африка (Яунде – ≈1.9%) |
| Португальский | 156.1                                          | ≈7.3%     | Бразилия (Сан-Паулу)                                                                   |
| Японский      | 142.2                                          | ≈6.6%     | Япония (Токио, Осака)                                                                  |
- ( \* )  - Процент взят из (avg по языку)/общий 

Исходя из этого можно 
###  Схема DNS балансировки (при наличии)


### Схема Anycast балансировки (при наличии)


### Механизм регулировки трафика между ДЦ (при наличии)


## Источники
[^1]:  https://www.demandsage.com/twitch-users
[^2]: https://analyzify.com/statsup/twitch
[^3]: https://twitchtracker.com/statistics
[^4]: https://leftronic.com/blog/twitch-statistics
[^5]: https://help.twitch.tv/s/article/video-on-demand?language=ru
[^6]: https://help.twitch.tv/s/article/multiple-encodes?language=ru
[^7]: https://www.sostav.ru/publication/twitch-49828.html
[^8]: https://au.finance.yahoo.com/news/twitch-caps-streamers-storage-100-150858673.html
[^9]:  https://discuss.dev.twitch.com/t/message-character-limit/7793
[^10]: https://help.twitch.tv/s/article/guide-to-using-twitch-inspector?language=ru
[^11]: https://twitchtracker.com/languages
