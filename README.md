# Twitch

## 1. Тема и целевая аудитория

Twitch -  видеостриминговый сервис.

### MVP

1. Регистрация/авторизация
2. Создать стрим
3. Смотреть стрим
4. Подписка на стримера
5. Писать в чат
6. Ставить реакции стриму, лайк/дизлайк 
7. Поиск стримеров по категориям, тегам, ключевым словам
8. Хранение записи стрима
9. Просмотр записи

### Ключевые продуктовые решения

- рекомендации стримов на основе интересов
- бесконечная лента прямых трансляций
- 7 дней хранения записи прямых трансляций для обычных пользователей и 60 дней для партнеров, на количество самих записей в этот период ограничений нет [^5] 
- буферизация прямых трансляций и записей 

### Целевая аудитория

#### Метрики вовлеченности:

- MAU 240M[^1]
- DAU 30M[^1]
- общее количество посещений за январь 2025 - 1.2B [^3]
- В месяц 7M человек запускает стрим хотя бы раз, активных стримеров в день 1.2M [^3]
- одновременно просматривает в среднем 2.5M пользователей, пик 7M [^3]
- одновременное количество прямых трансляций 100K  [^3]
- среднее количество стримов в месяц более 7M  [^3]
- среднее время общей длительности стримов за месяц - 65.7M, за день - 2.5M [^3]
- было отправлено более 28B ообщений в чате за год,
   т.е ~80M в день, ~2.33B в месяц (2023 год) [^4]
- на мобильные устройства приходится 35% всех просмотров [^1]
- средняя продолжительность прямой трансляции на Twitch 3 часа[^2]
- смотрят в среднем 1,7B часов контента в месяц  [^3]
- среднее время сессии 36 минут [^7]

#### Рекорды:

- одновременное количество зрителей - 3.44M
- максимальное количество подписчкиков - 19M

#### Распределение аудитории по полу и возрасту:

- 52% пользователей в возрасте 25-34 лет [^2]
- 22% пользователей в возрасте 35-44 лет [^2]
- 72% пользователей - мужчины

#### Распределение аудитории по странам

Десктоп трафик в 2024 [^2] 

| №   | Страна   | Количество пользователей | % от общего числа |
| --- | -------- | ------------------------ | ----------------- |
| 1   | США      | 49.5M                    | 20.6%             |
| 2   | Германия | 16.9M                    | 7.17%             |
| 3   | Россия   | 11.6M                    | 4.85%             |
| 4   | Франция  | 11.44M                   | 4.61%             |
| 5   | Япония   | 10.5M                    | 4.39%             |

## 2. Расчет нагрузки

### Продуктовые метрики
#### Аудитория [^1]

| Тип | Количество |
| --- | ---------- |
| MAU | 240M       |
| DAU | 30M        |

#### Действия пользователя

| Тип                     | Среднее в месяц<br>от 1 юзера | В месяц <br>от всех юзеров   |
| ----------------------- | ----------------------------- | ---------------------------- |
| Регистрация/авторизация | 0.05                          | 2M (регистраций) + 12M = 14M |
| Проведение<br>стрима    | 3ч                            | 75M часов                    |
| Просмотр<br>стрима      | 14мин*                        | 1.7B часов [^3]              |
| Подписки                | 3                             | 720M                         |
| Сообщения<br>в чате     | 9.7                           | 2.33B  [^4]                  |
| Реакций на<br>стрим     | 1.5                           | 360M                         |
| Поиск                   | 20                            | 4.8B                         |
| Посещения <br>профиля   | 4                             | 960M                         |
| Хранение записи         | 3                             | 720M                         |
| Просмотр записи         | 5                             | 1.2B                         |

- ( \* ) Из расчета, что MAU 240M[^1]

#### Хранилища

##### Пользователя:

| Тип               | Размер |
| ----------------- | ------ |
| Аватарка          | 200КБ  |
| Фото баннер       | 200КБ  |
| Общая информация* | ~2КБ   |
| Итого             | 402КБ  |

- ( \* ) Имя пользователя и отображаемое имя пользователя до 25 символов, информация  о себе до 300 символов, кодировка utf8 - 4б, итого 350 * 4б / 1024 ~ 2КБ
- Максимальный размер загружаемых аватарки/банеров 10МБ, но сжимается до 200КБ

##### Стримера

| Тип                 | Размер    |
| ------------------- | --------- |
| Стримы*             | 75ГБ      |
| Загружаемые видео** | 397,85ГБ  |
| Чат***              | 126Мб     |
| Итого               | 472.98Гб  |


У Twitch нет возможности вести прямую трансляцию в 2к и 4к, это находится на этапе тестирования [^6]. Twitch рекомендует делать трансляцию в 1080р с битрейтом 6000кбит/с [^6] . Средний размер файла на 1минуту с таким разрешением 40МБ. Но так как при просмотре записи Twitch предлагает выбор из качеств видео: 720р60 - в среднем 30МБ/мин, 480 - 11МБ/мин, 360 - 7МБ/мин, 240 - 5МБ/мин, 144 - 3МБ/мин.

Без потери качества можно сжать на 30%

- ( \* ) [Отсюда](#метрики-вовлеченности), информация, что общая длительность прямых трансляций 65.6M, и средняя продолжительность стрима - 3ч, и 7M активных стримеров в месяц (т.е проводят хотя бы 1 трансляцию в месяц) => 65.7M/7M = 9.4ч на стримера в месяц или ~3 стрима в месяц. Запись хранится 60 дней, т.е 2 месяца Посчитаем размер хранилища за 2 месяца: 2 * 9.4  * 60мин * (40 + 30 + 11 + 7 + 5 + 4) = 109416МБ. Итого после сжатия 109 416МБ* 0.7 = 76591.2МБ ~ 75ГБ.
- ( \** ) Максимум можно сохранить 100ч [^8]  . 100 * 60 * (40 + 30 + 11 + 7 + 5 + 4)МБ = 568,36ГБ. Итого: 568,36ГБ * 0.7 = 397,85
- ( \*** ) Из расчетов действий пользователя получим, что среднее количество сообщений в чате 1100, максимальный размер сообщения 500 символов [^9]  , при кодировке utf8 1100 * 500 * 4Б * 60= 126МБ

### Технические метрики
#### Хранилища

Точных данных по количеству зарезарегистрированных аккаунтов на Twitch нет, при MAU 240M пусть общее количество будет 2.4B (1 к 10). Стримеров в месяц 7M

| Тип          | Размер  |
| ------------ | ------- |
| Пользователи | 49.1ТБ  |
| Стримеры     | 3 150,94 |
| Итого        | 3 151ПБ |

#### Трафик и запросы
Twitch работает по протоколу RTMP [^10] ,  который работает поверх TCP. Раз в секунду делается запрос на получение фрагмента стрима.

| Тип                         | Средний RPS | Сетевой трафик<br>(средний) | Пиковый RPS | Сетевой трафик<br>(пиковый) |
| --------------------------- | ----------- | --------------------------- | ----------- | --------------------------- |
| регистрация<br>/авторизация | 6           | 12Мбит/с                  | 12          | 24Мбит/с                  |
| Проведение<br>стрима        | 100К        | 0.6Тбит/с                   | 250K        | 1.2Тбит/с                   |
| Просмотр<br>стрима          | 2.5M        | 15Тбит/с                    | 5M          | 30Тбит/с                    |
| Подписки                    | 300         | 240Мбит/с                   | 600         | 480Мбит/с                   |
| Чат                         | 1000        | 20Мбит/с                    | 2000        | 40Мбит/с                    |
| Реакции                     | 250K        | 120Мбит/с                   | 500K        | 240Мбит/с                   |
| Поиск                       | 2K          | 1000Мбит/с                  | 4К          | 2000Мбит/c                  |
| Переход <br>в профиль       | 370         | 1200Мбит/с                  | 740         | 2400Мбит/с                  |
| Хранение записи             | 300         | 1.72Гбит/с                  | 600         | 3.44Гбит/с                  |
| Просмотр записи             | 400         | 2.9Гбит/с                   | 800         | 5.8Гбит/с                   |
| Итого                       | 2.9M        | 15.6Тбит/с                  | 5.8M        | 32.7Тбит/с                  |

## 3. Глобальная балансировка нагрузки

### Функциональное разбиение по доменам (при наличии, нужно для следующего пункта)

Исходя из среднего RPS и потребления трафика можно выделить несколько доменов:
- streamer.twitch.tv
- viewer.twitch.tv
- chat.twitch.tv
- vod.twitch.tv (Video on Demand)

Основной тип нагрузки приходиться на сервис стриминга, логично вывести его в отдельный домен. Также много трафика уходит на просмотр. Большой  
### Обоснования расположения ДЦ (влияние на продуктовые метрики)

Twitch не предоставляет гарантии единой задержки для всех пользователей и может меняться в зависимости от скорости интернета, к примеру на картинке снизу, настройка слева - "4g - быстрый", справа - "4g - медленный", и задержка может замедлиться динамически при замедлении интернета и исчерпании буфера.

![MyCollages](https://github.com/user-attachments/assets/e17e32ac-505a-4455-89df-c4aa0acb9720)

При отсутствии гарантии по длительности задержки ЦОД Twitch можно расположить исходя из плотности населения и популярности сервиса в регионе.

В [части 1](#распределение-аудитории-по-странам), привел информацию по десктоп трафику, но нужно расширить и на мобильный трафик. 

Так как точные данные по трафику не раскрыты, можно сделать некоторые выводы из локальности языков [^11]:

| Язык          | Среднее количество<br>одновременных зрителей | Среднее количество<br>одновременных стримов |
| ------------- | -------------------------------------------- | ------------------------------------------- |
| Английский    | 1134.2K                                      | 56.1K                                       |
| Русский       | 253.7K                                       | 7.1K                                        |
| Испанский     | 185.5K                                       | 8.1K                                        |
| Немецкий      | 161K                                         | 4.6K                                        |
| Французкий    | 159.6K                                       | 4.9K                                        |
| Португальский | 156.1K                                       | 4.5K                                        |
| Японский      | 142.2K                                       | 4.5K                                        |

- На **испанском** языке говорят в следующих странах: Испания, страны Латинской Америки
- На **немецком** языке говорят в следующих странах: Германия, Австрия, Лихтенштейн, а также одним из официальных языков Швейцарии, Люксембурга и Бельгии.
- На русском языке говорят в следующих странах: Россия и Беларусь
- На французком языке говорят: 
	- в странах Европы: Франция, Бельгия, Люксембург и др
	- в странах Америки: Канада, США
	- в странах Африки
- На португальском говорят в следующих странах: Бразилия, в странах Африки

Исходя из этой информации можно преобразовать таблицу

| №   | Страна / Регионы                                                              | Основной язык | Десктоп (пользователей, млн / доля) | (сред. зрители / стримы) |
| --- | ----------------------------------------------------------------------------- | ------------- | ----------------------------------- | ------------------------ |
| 1   | США                                                                           | Английский    | 49.5M / 20.6%                       | 1134.2K / 56.1K          |
| 2   | Германия и сопутств. страны (Австрия, Швейцария, Лихтенштейн)                 | Немецкий      | 16.9M / 7.17%                       | 161K / 4.6K              |
| 3   | Россия, Беларусь, Казахстан                                                   | Русский       | 11.6M / 4.85%                       | 253.7K / 7.1K            |
| 4   | Франция и франкофонные регионы (Бельгия, Люксембург, Канада, часть США и др.) | Французский   | 11.44M / 4.61%                      | 159.6K / 4.9K            |
| 5   | Япония                                                                        | Японский      | 10.5M / 4.39%                       | 142.2K / 4.5K            |
| 6   | Испания и Латинская Америка                                                   | Испанский     | –                                   | 185.5K / 8.1K            |
| 7   | Бразилия и африканские страны                                                 | Португальский | –                                   | 156.1K / 4.5K            |


![mir-плотность](https://github.com/user-attachments/assets/4d2d929e-1fdc-493d-80b7-eae9393d4c8a)

![mir](https://github.com/user-attachments/assets/309ba1b6-a006-44d2-824a-db11708ac77f)

![asia-net](https://github.com/user-attachments/assets/278f28de-e7a7-48cc-85b7-e3bee58b6e17)

![asia](https://github.com/user-attachments/assets/5699d5d5-ce9f-4fe0-8e80-a3f8d080ad25)

![europe-net](https://github.com/user-attachments/assets/3b5c2afb-f97f-46c3-bbfb-b1a4dac06441)

![europe](https://github.com/user-attachments/assets/047fea84-951b-4e5b-9a0f-447cc83f471b)

![america-net](https://github.com/user-attachments/assets/92449627-5508-4acc-90d5-6817d0f94577)

![america](https://github.com/user-attachments/assets/dc0b37cd-ee87-45c8-941b-89ce550f423e)



Расположение ЦОД:
- В США: Сан-Франциско(Северная Калифорния), Лос-Анджелес(Калифорния), Нью-Йорк, Чарльстон(Южная Каролина), Колумбус(Огайо)
- В Великобритании: Лондон
- В Мексике: Мехико
- В Бразилии: Сан-Паулу
- В Испании: Мадрид
- Во Франции: Париж 2шт
- В Германии: Франкфурт 2шт
- В Японии: Токио, Осако
- В России: Москва,  Новосибирск, Санкт-Петербург 
- В Австралии: Сидней
- В Африке, страна Камерун: Яунде
- В Канаде: Торонто
### Расчет распределение запросов из секции "Расчет нагрузки" по типам запросов по датацентрам

| Язык          | avg RPS просмотр прямой трансляции (в тысячах) | Доля* (%) | Принадлежность к датацентрам                                                                  |
| ------------- | ---------------------------------------------- | --------- | --------------------------------------------------------------------------------------------- |
| Английский    | 1134.2                                         | ≈47.3%    | США(Сан-Франциско, Лос-Анджелес, Нью-Йорк, Чарльстон, Огайо) Англия(Лондон) Австралия(Сидней) |
| Русский       | 253.7                                          | ≈11.8%    | Россия(Москва ~6%,  Новосибирск ~1.8%, СПб 5%)                                                        |
| Испанский     | 185.5                                          | ≈8.6%     | Делится на: Испания (Мадрид – ≈4.3%) и Мексика (Мехико – ≈4.3%)                               |
| Немецкий      | 161                                            | ≈7.5%     | Германия(Франквурт)                                                                           |
| Французский   | 159.6                                          | ≈7.4%     | Делится на: Франция (Париж – ≈5%), Канада (Торонто – ≈2%) и Африка (Яунде – ≈0.4%)            |
| Португальский | 156.1                                          | ≈7.3%     | Бразилия (Сан-Паулу)                                                                          |
| Японский      | 142.2                                          | ≈6.6%     | Япония (Токио, Осака)                                                                         |

- ( \* )  - Процент взят из (avg по языку)/общий 

| ЦОД               | Доля  | RPS |sign<br>in/up | stream<br> | stream<br>views | subs  | chat | likes  | search | visit<br>profile | save<br>VOD | view<br>VOD |
| ----------------- | ----- | ---|------------- | ---------- | --------------- | ----- | ---- | ------ | ------ | ---------------- | ----------- | ----------- |
| **Сан‑Франциско** | 9.25% | 268250 |0.55          | 9.3K       | 231.5K          | 27.78 | 92.6 | 23.15K | 185.15 | 34.25            | 27.8        | 37          |
| **Лос‑Анджелес**  | 9.25% | 268250 |0.55          | 9.3K       | 231.5K          | 27.78 | 92.6 | 23.15K | 185.15 | 34.25            | 27.8        | 37          |
| **Нью‑Йорк**      | 7.40% | 214600 |	0.44          | 7.4K       | 185.2K          | 22.20 | 74.  | 18.52K | 148.12 | 27.40            | 22.2        | 29.7        |
| **Чарльстон**     | 5.55% | 160950 | 0.33          | 5.6K       | 138.9K          | 16.65 | 55.6 | 13.89K | 111.09 | 20.55            | 16.7        | 22.2        |
| **Колумбус**      | 5.55% | 160950 | 0.33          | 5.6K       | 138.9K          | 16.65 | 55.6 | 13.89K | 111.09 | 20.55            | 16.7        | 22.2        |
| **Лондон**        | 5%    | 145000 | 0.30          | 5K         | 125K            | 15    | 50   | 12.5K  | 100    | 38.5             | 31.7        | 42.3        |
| **Сидней**        | 5.3%  | 153700 | 0.32          | 5K         | 132K            | 15.87 | 52.9 | 13.2K  | 105.80 | 19.57            | 15.9        | 21.2        |
| **Москва**        | 6%    | 174000 | 0.36          | 6K         | 150K            | 18.00 | 60   | 15K    | 120    | 22.20            | 18          | 24          |
| **СПб**           | 5%    | 145000 | 0.30          | 5K         | 125K            | 15    | 50   | 12.5K  | 100    | 38.5             | 31.7        | 42.3        |
| **Мадрид**        | 4.3%  | 124700 | 0.26          | 4.3K       | 108K            | 13.05 | 43   | 10.9K  | 87     | 16.10            | 13          | 17.4        |
| **Мехико**        | 4.3%  | 124700 | 0.26          | 4.3K       | 108K            | 13.05 | 43   | 10.9K  | 87     | 16.10            | 13          | 17.4        |
| **Франкфурт**     | 7.5%  | 217500 | 0.45          | 7.5K       | 187.5K          | 22.50 | 75   | 18.7K  | 150    | 27.75            | 22.5        | 30          |
| **Париж**         | 5%    | 145000 | 0.30          | 5K         | 125K            | 15    | 50   | 12.5K  | 100    | 38.5             | 31.7        | 42.3        |
| **Торонто**       | 2%    | 58000 | 0.12          | 2K         | 50K             | 6     | 20   | 5K     | 40     | 7.4              | 6           | 8           |
| **Яунде**         | 0.4%  | 11600 | 0.024         | 400        | 10K             | 1.2   | 4    | 1K     | 8      | 1.48             | 1.2         | 1.6         |
| **Сан-Паулу**     | 7.3%  | 211700 | 0.44          | 7.3K       | 182.5K          | 21.90 | 73   | 18.3K  | 146    | 27.01            | 21.9        | 29.2        |
| **Токио**         | 3.3%  | 95700 | 0.20          | 3.3K       | 82.5K           | 9.90  | 33   | 8.3K   | 66     | 12.21            | 9.9         | 13.2        |
| **Осака**         | 3.3%  | 95700 | 0.20          | 3.3K       | 82.5K           | 9.90  | 33   | 8.3K   | 66     | 12.21            | 9.9         | 13.2        |

Итого получим общий трафик
- с США: 9.25% + 9.25% + 7.4% + 5.55% + 5.55% = 37%. Общий MAU 240M. 0.37\*240M ~ 89M
- с Лондона: 0.05 * 240M = 12M
- С Мексики и Испании: 0.043 * 240 = 10.3
- В Бразилии: 0.073 * 240M = 17.52M

Что коррелирует с информацией  [^3] [^12]
![Pasted image 20250302235953](https://github.com/user-attachments/assets/815e3794-3536-45e0-a1c8-d79ba78da635)

![Pasted image 20250303000404](https://github.com/user-attachments/assets/8adeb5d0-21bb-45e1-bdc9-dfc85c8f4344)


###  Схема DNS балансировки 

Поскольку дата-центры Twitch расположены по всему миру, целесообразно использовать Latency-based DNS. Пользователь, отправляя DNS-запрос, получает ответ от глобальной системы, которая измеряет задержку до каждого доступного дата-центра. На основании этих данных возвращается IP-адрес того дата-центра, где задержка минимальна. Это обеспечивает оптимальное качество трансляций и минимизацию буферизации.

### Схема Anycast балансировки 

Для обеспечения быстрого отклика и отказоустойчивости Twitch объединяет несколько географически распределённых серверов под одним Anycast IP-адресом. Запросы пользователей направляются через глобальную BGP-сеть к ближайшему узлу. 

1. Северная Америка
   - **ЦОДы объявляют один Anycast IP через BGP:** Сан‑Франциско, Лос‑Анджелес, Нью‑Йорк, Чарльстон, Колумбус, Торонто, Мехико
2. Европа и Россия
   Лондон, Мадрид, Франкфурт, Париж, Москва
3. Азиатско-Тихоокеанский регион
   Токио, Осака, Сидней

### Механизм регулировки трафика между ДЦ 

В регионах с большой нагрузкой, например в США распределяем трафик посредством хэша, для того чтобы равномерно делить нагрузку между ЦОД.

## Источники
[^1]:  https://www.demandsage.com/twitch-users
[^2]: https://analyzify.com/statsup/twitch
[^3]: https://twitchtracker.com/statistics
[^4]: https://leftronic.com/blog/twitch-statistics
[^5]: https://help.twitch.tv/s/article/video-on-demand?language=ru
[^6]: https://help.twitch.tv/s/article/multiple-encodes?language=ru
[^7]: https://www.sostav.ru/publication/twitch-49828.html
[^8]: https://au.finance.yahoo.com/news/twitch-caps-streamers-storage-100-150858673.html
[^9]:  https://discuss.dev.twitch.com/t/message-character-limit/7793
[^10]: https://help.twitch.tv/s/article/guide-to-using-twitch-inspector?language=ru
[^11]: https://twitchtracker.com/languages
[^12]: https://worldpopulationreview.com/country-rankings/twitch-users-by-country
